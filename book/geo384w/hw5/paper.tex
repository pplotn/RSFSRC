\author{Jean Baptiste Joseph Fourier} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Homework 5}

\begin{abstract}
  This homework has only a computational part but it will require you
  to make some theoretical developments as well.  You will develop
  efficient approximations for one-way extrapolators and
  experiment with wave-equation migration by least-squares inversion
  and reverse-time migration.
\end{abstract}

Completing the computational part of this homework assignment requires
\begin{itemize}
\item \texttt{Madagascar} software environment available from \\
  \url{http://www.ahay.org}
\item \LaTeX\ environment with \texttt{SEGTeX} available from \\ 
  \url{http://www.ahay.org/wiki/SEGTeX}
\end{itemize}

You are welcome to do the assignment on your personal computer by
installing the required environments. In this case, you can obtain all
homework assignments from the \texttt{Madagascar} repository by running
\begin{verbatim}
svn co https://github.com/ahay/src/trunk/book/geo384w/hw5
\end{verbatim}

\section{Computational part}

\begin{enumerate}

\item The first example is the model from Homework 1 with a hyperbolic
  reflector under a constant velocity layer.  The model is shown in
  Figure~\ref{fig:model}. Figure~\ref{fig:shot} shows a shot gather
  modeled at the surface and extrapolated to a level of 1 km in depth
  using two extrapolation operators: 
  \begin{enumerate}
  \item The exact phase shift filter
    \begin{equation}
      \label{eq:ps}
      \hat{U}(z,k,\omega) = \hat{U}(0,k,\omega)\,e^{i\,\sqrt{S^2\,\omega^2 - k^2}\,z}\;.
    \end{equation}
  \item Its approximation
    \begin{equation}
      \label{eq:psa}
      \hat{U}(z,k,\omega) \approx \hat{U}(0,k,\omega)\,
      e^{i\,S\,\omega\,z}\,
      \frac
      {\displaystyle S\,\omega + \frac{i\,\left(\cos{(k\,\Delta x)}-1\right)\,z}{2\,(\Delta x)^2}}
      {\displaystyle S\,\omega - \frac{i\,\left(\cos{(k\,\Delta x)}-1\right)\,z}{2\,(\Delta x)^2}}\;.
    \end{equation}
    Approximation~(\ref{eq:psa}) is suitable for an implementation in the space domain
    with a digital recursive filter. However, its accuracy is limited,
    which is evident both from Figure~\ref{fig:shot} and from
    Figure~\ref{fig:phase}, which compares the phases of the exact and
    the approximate extrapolators. We can see that
    approximation~(\ref{eq:psa}) is accurate only for small angles
    from the vertical~$\theta$, defined by 
\[
\theta = \arcsin\left(\frac{k}{S\,\omega}\right)\;.
\] 
  \end{enumerate}

  \textbf{Your task:} Design an approximation that would be more accurate
    than approximation~(\ref{eq:psa}). Your approximation should be
    suitable for a digital filter implementation in the space
    domain. Therefore, it can involve $k$ only through $\cos{(n\,k\,\Delta
      x)}$ functions with integer $n$.
    \begin{enumerate}
    \item Change directory 
\begin{verbatim}
cd hw5/hyper
\end{verbatim}
    \item Run
\begin{verbatim}
scons view
\end{verbatim}
      to generate figures and display them on your screen.  
    \item Edit the \texttt{SConstruct} file to change the approximate extrapolator.
    \item Run
\begin{verbatim}
scons view
\end{verbatim}
      again to observe the differences.
    \end{enumerate}

\inputdir{hyper}

\plot{model}{width=0.85\textwidth}{Synthetic velocity model with a hyperbolic reflector.}

\plot{shot}{width=\textwidth}{Synthetic shot gather. Left: Modeled for receivers at the surface. Middle: Receivers extrapolated to 1 km in depth with an exact phase-shift extrapolation operator. Right: Receivers extrapolated to 1 km in depth with an approximate extrapolation operator.}

\sideplot{phase}{width=\textwidth}{Phase of the extrapolation operator at 5 Hz frequency as a function of the wave propagation angle. Solid line: exact extrapolator. Dashed line: approximate extrapolator.}

\lstset{language=python,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{hyper/SConstruct}

\item Now we will approach the imaging
  task using reverse-time migration with a two-way wave
  extrapolation. Figure~\ref{fig:data} shows synthetic zero-offset
  data generated by Kirchhoff modeling. Figure~\ref{fig:image} shows
  an image generated by zero-offset reverse-time migration using an
  explicit finite-difference wave extrapolation in time.

   \textbf{Your task:} Change the program for reverse-time migration to
  implement forward-time modeling using the ``exploding reflector''
  approach.

    \begin{enumerate}
    \item Change directory 
\begin{verbatim}
cd hw6/hyper2
\end{verbatim}
    \item Run
\begin{verbatim}
scons view
\end{verbatim}
      to generate figures and display them on your screen.
  \item Run
\begin{verbatim}
scons wave.vpl
\end{verbatim}
      to observe a movie of reverse-time wave extrapolation.
    \item Edit the program in the \texttt{rtm.c} file (or
      \texttt{rtm.py}) to implement a process opposite to migration: starting from the reflectivity image like the one in Figure~\ref{fig:image} and generating zero-offset data like the one in Figure~\ref{fig:data}. 
    \item Run
\begin{verbatim}
scons view
\end{verbatim}
      again to observe the differences.
    \end{enumerate}
 
\inputdir{hyper2}

\multiplot{2}{data,image}{width=0.8\textwidth}{(a) Synthetic zero-offset data corresponding to the model in Figure~\ref{fig:model}. (b) Image generated by reverse-time exploding-reflector migration. The location of the exact reflector is indicated by a curve.}

\lstset{language=python,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{hyper2/SConstruct}

\lstset{language=c,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{hyper2/rtm.c}

\lstset{language=python,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{hyper2/rtm.py}

%\newpage

\item  Figure~\ref{fig:zvel,zref} shows the Sigsbee velocity model and its an approximate filtered reflectivity. 

\inputdir{sigsbee}

\multiplot{2}{zvel,zref}{width=\textwidth}{(a) Sigsbee velocity model. (b) Approximate reflectivity of the Sigsbee model (an ideal image).}

  \textbf{Your task:} Apply your exploding-reflector modeling and migration program from the previous task to generate zero-offset data for Sigsbee and image it.

    \begin{enumerate}
    \item Change directory 
\begin{verbatim}
cd hw6/sigsbee
\end{verbatim}
    \item Run
\begin{verbatim}
scons view
\end{verbatim}
      to generate figures and display them on your screen.  
    \item Modify the \texttt{SConstruct} file to implement the modeling and migration experiment.
    \item Include your results in the paper by editing the \texttt{hw6/paper.tex} file.
    \end{enumerate}

\lstset{language=python,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{sigsbee/SConstruct}

%\newpage

\item  We return to the synthetic model shown in Figure~\ref{fig:lmodel} to experiment with  modeling and migration by the phase-shift method in a $V(z)$ medium. 

Figure~\ref{fig:expl} shows an idealized image (band-passed
reflectivity) for the synthetic model. In ``exploding-reflector''
modeling, this image is assumed to be the seismic wavefield frozen at
zero time. The modeling program extrapolates the wavefield to the
surface and is implemented in \texttt{phaseshift.c}. The program
operates in the frequency-wavenumber domain and establishes a linear
relationship between reflectivity as a function of depth and
zero-offset data as a function of frequency for one space wavenumber.
If we think of this linear relationship as a matrix multiplication, we
can associate forward modeling with multiplication\begin{equation}
\label{eq:mod}
\mathbf{d} = \mathbf{A}\,\mathbf{m}
\end{equation}
and migration with the adjoint multiplication
\begin{equation}
\label{eq:mig}
\widehat{\mathbf{m}} = \mathbf{A}^T\,\mathbf{d}\;,
\end{equation}
where $\mathbf{A}^T$ is the conjugate transpose of $\mathbf{A}$.

Figure~\ref{fig:modl} shows the result of forward modeling
(multiplication by $\mathbf{A}$) after inverse Fourier transform to
time and space. Your task is to implement the corresponding migration
(multiplication by $\mathbf{A}^T$). 

Instead of simply applying the adjoint operator, we can also try to compute
the \emph{least-squares inverse}
\begin{equation}
\label{eq:lsmig}
\widehat{\mathbf{m}} = \left(\mathbf{A}^T\,\mathbf{A}\right)^{-1}\,\mathbf{A}^T\,\mathbf{d}\;,
\end{equation}
which corresponds to the minimum of the least-squares misfit function
$|\mathbf{A}\,\mathbf{m}-\mathbf{d}|^2$. In practice, inversion in
equation~(\ref{eq:lsmig}) is implemented with an
iterative \emph{conjugate-gradient} algorithm, which applies
$\mathbf{A}$ and $\mathbf{A}^T$ (modeling and migration) at each
iteration without the need to form any matrices explicitly.

  \inputdir{lsmig}

  \multiplot{2}{lmodel,expl}{width=0.45\textwidth}{(a) Synthetic model: curved
    reflectors in a $V(z)$ velocity. (b) ``Exploding reflector'', an ideal image of band-passed reflectivity.}
    \plot{modl}{width=0.8\textwidth}{Zero-offset data generated by exploding-reflector phase-shift modeling.}

\begin{enumerate}
\item Change directory 
\begin{verbatim}
cd hw5/lsmig
\end{verbatim}
\item Run
\begin{verbatim}
scons view
\end{verbatim}
to generate the figures and display them on your screen.
\item Modify the program in the \texttt{phaseshift.c} file to fill the missing part and to implement phase-shift migration as the adjoint of phase-shift modeling. 
\item Modify the \texttt{SConstruct} file to uncomment the part related to migration. Check your result by running
\begin{verbatim}
scons migr.view
\end{verbatim}
\item Test if your migration code is truly the adjoint of modeling by running the dot-product test
\begin{verbatim}
sfcdottest ./phaseshift.exe mod=kexpl.rsf dat=kmodl.rsf \
vel=vofz.rsf nw=247 dw=0.16276
\end{verbatim}
On a machine with multiple CPUs, you can also try
\begin{verbatim}
sfcdottest sfomp ./phaseshift.exe split=2 \
mod=kexpl.rsf dat=kmodl.rsf vel=vofz.rsf nw=247 dw=0.16276
\end{verbatim}
If your adjoint is correct, you should see two identical sets of numbers, such as
\begin{verbatim}
sfcdottest:  L[m]*d=(25264,-20273.9)
sfcdottest: L'[d]*m=(25264,-20273.9)
\end{verbatim}
Your actual numbers will be different because of random input vectors but they should be the same between \verb+L[m]*d+ and \verb+L'[d]*m+.
\item Now you are ready for testing least-squares migration. Uncomment the corresponding lines in \texttt{SConstruct} and run
\begin{verbatim}
scons invs.view
\end{verbatim}
Do you notice any difference with the previous result? Increase the
number of iterations from 10 to 100 and repeat the experiment.  
\item Include your figures in this document by 
  editing \texttt{hw5/paper.tex}.

\item For EXTRA CREDIT, use two-way wave extrapolation from the
  previous part to implement least-squares exploding-reflector
  reverse-time migration and apply it to the Sigsbee model.
  
\end{enumerate}

\lstset{language=python,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{lsmig/SConstruct}

\lstset{language=c,numbers=left,numberstyle=\tiny,showstringspaces=false}
\lstinputlisting[frame=single]{lsmig/phaseshift.c}

\end{enumerate}

%\newpage

\section{Completing the assignment}

\begin{enumerate}
\item Change directory to \texttt{hw5}.
\item Edit the file \texttt{paper.tex} in your favorite editor and change the first line to have your name instead of Fourier's.
\item Run
\begin{verbatim}
sftour scons lock
\end{verbatim}
to update all figures.
\item Run
\begin{verbatim}
sftour scons -c
\end{verbatim}
to remove intermediate files.
\item Run
\begin{verbatim} 
scons pdf
\end{verbatim}
to create the final document.
\item Submit your result (file \texttt{paper.pdf}) on paper or by
  e-mail. 
\end{enumerate}


